name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-python:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run Python syntax checks
      run: |
        python -m py_compile scripts/*.py
        python -m py_compile tools/*.py

    - name: Test core imports
      run: |
        python -c "import numpy as np; import pandas as pd; import matplotlib.pyplot as plt; import torch; print('✓ Core dependencies imported successfully')"

    - name: Test utils metrics
      run: |
        python -c "from scripts import utils_metrics; print('✓ Utils metrics imported successfully')"

  test-rust:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        rustflags: ""

    - name: Cache Cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          src/rust/core/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Build and test Rust code
      env:
        RUSTFLAGS: ""
      run: |
        cd src/rust/core
        cargo build --verbose
        cargo test --verbose

  docker-build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Build Docker image
      run: |
        docker build -t umst-prototype:test .

    - name: Test Docker image
      run: |
        docker run --rm umst-prototype:test python --version
        docker run --rm umst-prototype:test cargo --version

  data-integrity:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install pandas numpy

    - name: Check data integrity
      run: |
        python -c "
        import pandas as pd
        import os

        # Check all dataset files
        datasets = ['dataset_D1.csv', 'dataset_D2.csv', 'dataset_D3.csv', 'dataset_D4.csv']
        expected_columns = ['cement', 'slag', 'fly_ash', 'water', 'superplasticizer', 'coarse_agg', 'fine_agg', 'age', 'strength', 'source']

        for dataset in datasets:
            if os.path.exists(f'data/{dataset}'):
                df = pd.read_csv(f'data/{dataset}')
                assert list(df.columns) == expected_columns, f'Column mismatch in {dataset}'
                assert len(df) > 0, f'Empty dataset: {dataset}'
                print(f'✓ {dataset}: {len(df)} rows, {len(df.columns)} columns')
            else:
                print(f'✗ Missing: {dataset}')
        "

  reproducibility-check:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        rustflags: ""

    - name: Build Rust kernel
      run: |
        cd src/rust/core
        cargo build --release

    - name: Check SSOT file exists
      run: |
        if [ -f "results/ssot/fair_comparison_2026-01-28.json" ]; then
          echo "✓ SSOT file exists"
          python -c "import json; json.load(open('results/ssot/fair_comparison_2026-01-28.json')); print('✓ SSOT is valid JSON')"
        else
          echo "✗ SSOT file missing"
          exit 1
        fi

  archive-size-check:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Check repository size
      run: |
        # Calculate total size
        TOTAL_SIZE=$(du -sb . | cut -f1)
        TOTAL_MB=$((TOTAL_SIZE / 1024 / 1024))

        echo "Repository size: ${TOTAL_MB}MB"

        # Standard reproducibility package limit
        if [ $TOTAL_MB -gt 100 ]; then
          echo "⚠️  Repository size (${TOTAL_MB}MB) exceeds recommended limit (100MB)"
          exit 1
        else
          echo "✓ Repository size (${TOTAL_MB}MB) is within recommended limits"
        fi